<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda Semanal</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant:wght@400;600&family=Montserrat:wght@700&display=swap" rel="stylesheet">
</head>
<body>

    <header>
        <h1>üóìÔ∏è Reuni√µes da Semana</h1>
        <div>
            <button id="openBulkImportModal" class="btn-secondary">Importar Lote / Manuten√ß√£o</button>
            <button id="openNewMeetingModal" class="btn-primary">Criar Nova Reuni√£o</button>
        </div>
    </header>

    <main id="meeting-list">
        </main>

    <div id="newMeetingModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Nova Reuni√£o</h2>
            <form id="newMeetingForm">
                <label for="meetingTitle">T√≠tulo:</label>
                <input type="text" id="meetingTitle" required maxlength="100">

                <label for="meetingDate">Data:</label>
                <input type="date" id="meetingDate" required>

                <label for="meetingTime">Hora:</label>
                <input type="time" id="meetingTime" required>
                
                <label for="meetingPassword">Senha para Salvar:</label>
                <input type="password" id="meetingPassword" required>

                <button type="submit" class="btn-primary">Salvar Reuni√£o</button>
            </form>
        </div>
    </div>

    <div id="bulkImportModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Importa√ß√£o em Lote de Reuni√µes</h2>
            <p>Formato esperado para cada linha: <code>YYYY-MM-DD T√≠tulo da Reuni√£o HH:MM</code>.</p>
            <form id="bulkImportForm">
                <label for="importPassword">Senha de Administrador:</label>
                <input type="password" id="importPassword" required>

                <label for="importData">Lista de Reuni√µes (uma por linha):</label>
                <textarea id="importData" rows="10" required placeholder="2025-11-28 T√≠tulo da Reuni√£o 1 19:00
2025-11-29 T√≠tulo da Reuni√£o 2 15:30
..."></textarea>

                <button type="submit" class="btn-primary">Importar e Salvar Lote</button>
            </form>

            <hr style="margin: 20px 0;">
            
            <h3>‚ö†Ô∏è √Årea de Manuten√ß√£o (Reset Total)</h3>
            <p style="color: #cc0000; font-weight: bold;">Cuidado: Isso apagar√° TODAS as reuni√µes salvas no Firestore.</p>
            <form id="resetForm">
                <label for="resetPassword">Confirme a Senha para Reset Total (dm123):</label>
                <input type="password" id="resetPassword" required>
                <button type="submit" class="btn-danger" style="width: 100%; margin-top: 10px;">APAGAR TODAS AS REUNI√ïES</button>
            </form>
        </div>
    </div>

    <div id="addParticipantModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 id="participantMeetingTitle">Adicionar Participante</h2>
            <form id="addParticipantForm">
                <input type="hidden" id="participantMeetingId">

                <label for="participantName">Nome:</label>
                <input type="text" id="participantName" required maxlength="50">

                <label for="participantRole">Cargo (Ex: MCE):</label>
                <input type="text" id="participantRole" required maxlength="10">

                <button type="submit" class="btn-primary">Adicionar</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, query, where, deleteDoc, orderBy } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js';

        // SEU firebaseConfig
        const firebaseConfig = {
            apiKey: "AIzaSyBn_Wqa33wPRetrfm0-n_MVZGahi2dannY",
            authDomain: "e-na-estrada-dm.firebaseapp.com",
            projectId: "e-na-estrada-dm",
            storageBucket: "e-na-estrada-dm.firebaseapp.com",
            messagingSenderId: "597150480236",
            appId: "1:597150480236:web:4eb6d334d4d0672d8ba549",
            measurementId: "G-LX0MBXGY5W"
        };
        
        const CORRECT_PASSWORD = "dm123"; // Senha de Administrador

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const REUNIOES_COLLECTION = "reunioes";

        // --- Fun√ß√µes Auxiliares de Data ---

        const getNextDayOfWeek = (dayIndex) => { // 0=Dom, 1=Seg... 6=S√°b
            const today = new Date();
            const resultDate = new Date(today);
            const currentDay = today.getDay();
            let daysUntil = dayIndex - currentDay;

            if (daysUntil < 0) {
                daysUntil += 7; 
            }

            resultDate.setDate(today.getDate() + daysUntil);
            resultDate.setHours(0, 0, 0, 0); 
            return resultDate;
        };

        const formatDate = (dateISO, includeDayOfWeek = true) => {
            const date = new Date(dateISO + 'T00:00:00'); 
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const dayOfWeek = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'][date.getDay()];
            return includeDayOfWeek ? `${dayOfWeek} ‚Äî ${day}/${month}` : `${day}/${month}`;
        };

        // --- Rotinas de Manuten√ß√£o ---

        const resetOldMeetings = async () => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // 5 = Sexta-feira (In√≠cio da semana de interesse)
            const targetDayIndex = 5; 

            let daysSinceTarget = (today.getDay() - targetDayIndex + 7) % 7;

            const cutoffDate = new Date(today);
            cutoffDate.setDate(today.getDate() - daysSinceTarget);
            cutoffDate.setHours(0, 0, 0, 0); 

            const cutoffDateISO = cutoffDate.toISOString().split('T')[0];

            console.log(`[RESET SEMANAL] Verificando reuni√µes anteriores a (Corte na √∫ltima Sexta): ${cutoffDateISO}`);

            const q = query(
                collection(db, REUNIOES_COLLECTION),
                where("dataISO", "<", cutoffDateISO)
            );

            try {
                const snapshot = await getDocs(q);
                const docsToDelete = [];

                if (snapshot.empty) {
                    console.log("[RESET SEMANAL] Nenhuma reuni√£o antiga para deletar.");
                    return;
                }

                snapshot.forEach(doc => {
                    docsToDelete.push(doc.ref);
                });

                if (docsToDelete.length > 0) {
                    console.log(`[RESET SEMANAL] Deletando ${docsToDelete.length} reuni√µes antigas...`);
                    const deletePromises = docsToDelete.map(ref => deleteDoc(ref));
                    await Promise.all(deletePromises);
                    console.log("[RESET SEMANAL] Dele√ß√£o de reuni√µes antigas conclu√≠da.");
                }
            } catch (e) {
                console.error("[RESET SEMANAL] Erro durante a rotina de reset: ", e);
            }
        };
        
        // --- NOVO: Rotina de Reset Total ---
        const resetAllMeetings = async () => {
            if (!confirm("TEM CERTEZA? Esta a√ß√£o apagar√° TODAS as reuni√µes (e seus participantes) do banco de dados!")) {
                return;
            }

            const q = query(collection(db, REUNIOES_COLLECTION));
            let totalDeleted = 0;

            try {
                const snapshot = await getDocs(q);
                const deletePromises = [];
                
                if (snapshot.empty) {
                    alert("Nenhuma reuni√£o encontrada para apagar.");
                    return;
                }
                
                snapshot.forEach(doc => {
                    // Adiciona promessa para deletar o documento principal (reuni√£o)
                    deletePromises.push(deleteDoc(doc.ref));
                    totalDeleted++;
                });

                await Promise.all(deletePromises);
                
                alert(`Sucesso! ${totalDeleted} reuni√µes apagadas.`);
                document.getElementById('resetPassword').value = '';
                bulkImportModal.style.display = 'none';
                loadMeetings(); // Recarrega a lista
            } catch (e) {
                console.error("[RESET TOTAL] Erro ao apagar reuni√µes: ", e);
                alert(`Erro ao apagar. Verifique as regras do Firestore (allow delete: if true). Erro: ${e.message}`);
            }
        };

        // --- Renderiza√ß√£o e Carregamento de Dados ---

        const daysOfInterest = [
            { dayIndex: 5, name: 'Sexta' },
            { dayIndex: 6, name: 'S√°bado' },
            { dayIndex: 0, name: 'Domingo' }
        ];
        const dayMap = {};

        const setupDayStructure = () => {
            const meetingList = document.getElementById('meeting-list');
            meetingList.innerHTML = ''; 

            daysOfInterest.forEach(dayInfo => {
                const dayDate = getNextDayOfWeek(dayInfo.dayIndex);
                const dayDateISO = dayDate.toISOString().split('T')[0];
                dayMap[dayDateISO] = dayInfo; 

                const dayBlock = document.createElement('section');
                dayBlock.className = 'day-block';
                dayBlock.innerHTML = `
                    <h2>${dayInfo.name} ‚Äî ${formatDate(dayDateISO, false)}</h2>
                    <div id="meetings-for-${dayDateISO}" class="meetings-container">
                        <p class="no-meetings">Nenhuma reuni√£o agendada para este dia.</p>
                    </div>
                `;
                meetingList.appendChild(dayBlock);
            });
        };

        const renderMeetings = (meetings) => {
            document.querySelectorAll('.meetings-container').forEach(container => {
                container.innerHTML = '<p class="no-meetings">Nenhuma reuni√£o agendada para este dia.</p>';
            });

            meetings.forEach(meeting => {
                const containerId = `meetings-for-${meeting.dataISO}`;
                const container = document.getElementById(containerId);

                if (container) {
                    const noMeetingsMsg = container.querySelector('.no-meetings');
                    if (noMeetingsMsg) noMeetingsMsg.remove();

                    const meetingDiv = document.createElement('div');
                    meetingDiv.className = 'meeting-card';
                    meetingDiv.dataset.id = meeting.id;
                    meetingDiv.innerHTML = `
                        <div class="meeting-header">
                            <span class="meeting-time-badge">${meeting.hora}</span>
                            <h3 class="meeting-title">${meeting.titulo}</h3>
                        </div>
                        <ul class="participant-list" id="participants-for-${meeting.id}">
                            ${meeting.participantes.map(p => `<li>${p.nome} <span class="participant-role">(${p.cargo})</span></li>`).join('')}
                        </ul>
                        <button class="add-participant-btn" data-id="${meeting.id}" data-title="${meeting.titulo}">+ Participante</button>
                    `;

                    // Ordena por hora
                    let inserted = false;
                    const existingMeetings = Array.from(container.children).filter(el => el.classList.contains('meeting-card'));
                    for (const existing of existingMeetings) {
                        const existingTime = existing.querySelector('.meeting-time-badge').textContent;
                        if (meeting.hora < existingTime) {
                            container.insertBefore(meetingDiv, existing);
                            inserted = true;
                            break;
                        }
                    }
                    if (!inserted) {
                        container.appendChild(meetingDiv);
                    }
                }
            });

            document.querySelectorAll('.add-participant-btn').forEach(btn => {
                btn.onclick = () => openAddParticipantModal(btn.dataset.id, btn.dataset.title);
            });
        };

        const loadMeetings = async () => {
            const allMeetings = [];
            
            const q = query(
                collection(db, REUNIOES_COLLECTION),
                where("dataISO", "in", Object.keys(dayMap)),
                orderBy("dataISO"),
                orderBy("hora")
            );

            try {
                const snapshot = await getDocs(q);
                for (const docSnapshot of snapshot.docs) {
                    const meetingData = docSnapshot.data();
                    const meetingId = docSnapshot.id;

                    const participantsSnapshot = await getDocs(collection(db, REUNIOES_COLLECTION, meetingId, "participantes"));
                    const participantes = participantsSnapshot.docs.map(p => p.data());

                    allMeetings.push({
                        id: meetingId,
                        ...meetingData,
                        participantes: participantes || []
                    });
                }
                renderMeetings(allMeetings);
            } catch (e) {
                console.error("Erro ao carregar reuni√µes: ", e);
                alert("Erro ao carregar reuni√µes. Verifique o console. Se for erro de 'index', crie o √≠ndice no Firebase.");
            }
        };

        // --- Modals e Formul√°rios ---
        const newMeetingModal = document.getElementById('newMeetingModal');
        const openNewMeetingModalBtn = document.getElementById('openNewMeetingModal');
        const bulkImportModal = document.getElementById('bulkImportModal');
        const openBulkImportModalBtn = document.getElementById('openBulkImportModal');
        const closeBtns = document.querySelectorAll('.close-btn');
        const newMeetingForm = document.getElementById('newMeetingForm');
        const addParticipantModal = document.getElementById('addParticipantModal');
        const addParticipantForm = document.getElementById('addParticipantForm');
        const bulkImportForm = document.getElementById('bulkImportForm');
        const resetForm = document.getElementById('resetForm'); // Novo Formul√°rio de Reset

        openNewMeetingModalBtn.onclick = () => newMeetingModal.style.display = 'block';
        openBulkImportModalBtn.onclick = () => bulkImportModal.style.display = 'block';

        closeBtns.forEach(btn => {
            btn.onclick = () => {
                newMeetingModal.style.display = 'none';
                addParticipantModal.style.display = 'none';
                bulkImportModal.style.display = 'none';
            };
        });
        window.onclick = (event) => {
            if (event.target == newMeetingModal) newMeetingModal.style.display = 'none';
            if (event.target == addParticipantModal) addParticipantModal.style.display = 'none';
            if (event.target == bulkImportModal) bulkImportModal.style.display = 'none';
        };

        const openAddParticipantModal = (meetingId, meetingTitle) => {
            document.getElementById('participantMeetingId').value = meetingId;
            document.getElementById('participantMeetingTitle').textContent = `Adicionar Participante: ${meetingTitle}`;
            document.getElementById('participantName').value = '';
            document.getElementById('participantRole').value = '';
            addParticipantModal.style.display = 'block';
        };

        // Submiss√£o de Nova Reuni√£o (COM SENHA)
        newMeetingForm.onsubmit = async (e) => {
            e.preventDefault();
            const titulo = document.getElementById('meetingTitle').value;
            const dataISO = document.getElementById('meetingDate').value;
            const hora = document.getElementById('meetingTime').value;
            const password = document.getElementById('meetingPassword').value;

            // 1. VERIFICA√á√ÉO DE SENHA
            if (password !== CORRECT_PASSWORD) {
                alert("Senha incorreta. Voc√™ n√£o tem permiss√£o para adicionar reuni√µes.");
                document.getElementById('meetingPassword').value = ''; 
                return;
            }
            
            // 2. Valida√ß√£o simples: n√£o permite datas passadas
            if (dataISO < new Date().toISOString().split('T')[0]) {
                 alert("Por favor, selecione uma data no presente ou futuro.");
                 return;
            }

            try {
                const docRef = await addDoc(collection(db, REUNIOES_COLLECTION), {
                    titulo,
                    dataISO, 
                    hora,   
                    createdAt: new Date().toISOString()
                });
                newMeetingModal.style.display = 'none';
                newMeetingForm.reset();
                alert(`Reuni√£o "${titulo}" salva com sucesso!`);
                loadMeetings(); 
            } catch (e) {
                console.error("Erro ao adicionar documento: ", e);
                alert(`Erro ao salvar a reuni√£o. Erro: ${e.message}`);
            }
        };

        // Submiss√£o de Importa√ß√£o em Lote
        bulkImportForm.onsubmit = async (e) => {
            e.preventDefault();
            const importPassword = document.getElementById('importPassword').value;
            const importData = document.getElementById('importData').value;
            
            // 1. VERIFICA√á√ÉO DE SENHA
            if (importPassword !== CORRECT_PASSWORD) {
                alert("Senha incorreta. Voc√™ n√£o tem permiss√£o para importar reuni√µes.");
                document.getElementById('importPassword').value = '';
                return;
            }

            const lines = importData.trim().split('\n').filter(line => line.trim() !== '');
            let successCount = 0;
            let errorCount = 0;
            const promises = [];
            
            // 2. Processa cada linha
            for (const line of lines) {
                // Regex: YYYY-MM-DD (Grupo 1) + T√≠tulo (Grupo 2) + HH:MM (Grupo 3)
                const match = line.match(/^(\d{4}-\d{2}-\d{2})\s(.+)\s(\d{2}:\d{2})$/);
                
                if (match) {
                    const dataISO = match[1];
                    const titulo = match[2].trim();
                    const hora = match[3];

                    // *** IMPORTANTE: N√£o h√° mais checagem de data passada aqui ***
                    
                    // Adiciona promessa de salvamento
                    promises.push(addDoc(collection(db, REUNIOES_COLLECTION), {
                        titulo,
                        dataISO, 
                        hora,   
                        createdAt: new Date().toISOString()
                    }).then(() => {
                        successCount++;
                    }).catch(e => {
                        console.error(`[LOTE] Erro ao salvar linha "${line}":`, e);
                        errorCount++;
                    }));
                } else {
                    console.warn(`[LOTE] Linha com formato inv√°lido: ${line}`);
                    errorCount++;
                }
            }

            await Promise.all(promises);
            
            bulkImportModal.style.display = 'none';
            bulkImportForm.reset();
            
            if (successCount > 0 || errorCount > 0) {
                 alert(`Importa√ß√£o conclu√≠da: ${successCount} reuni√£o(√µes) salvas com sucesso. ${errorCount} linha(s) ignorada(s) ou com erro.`);
                loadMeetings();
            } else {
                 alert(`Nenhuma reuni√£o importada. Verifique se o formato e a senha est√£o corretos.`);
            }
        };
        
        // Submiss√£o de Reset Total (NOVO LISTENER)
        resetForm.onsubmit = async (e) => {
            e.preventDefault();
            const resetPassword = document.getElementById('resetPassword').value;
            
            if (resetPassword !== CORRECT_PASSWORD) {
                alert("Senha incorreta. A opera√ß√£o de reset foi abortada.");
                document.getElementById('resetPassword').value = '';
                return;
            }

            await resetAllMeetings();
        };


        // Submiss√£o de Novo Participante (Inalterado)
        addParticipantForm.onsubmit = async (e) => {
            e.preventDefault();
            const meetingId = document.getElementById('participantMeetingId').value;
            const nome = document.getElementById('participantName').value;
            const cargo = document.getElementById('participantRole').value;

            try {
                await addDoc(collection(db, REUNIOES_COLLECTION, meetingId, "participantes"), {
                    nome,
                    cargo,
                    joinedAt: new Date().toISOString()
                });
                addParticipantModal.style.display = 'none';
                addParticipantForm.reset();
                alert(`Participante ${nome} adicionado com sucesso!`);
                loadMeetings(); 
            } catch (e) {
                console.error("Erro ao adicionar participante: ", e);
                alert("Erro ao adicionar participante.");
            }
        };

        // --- Inicializa√ß√£o ---

        const init = async () => {
            setupDayStructure(); 
            await resetOldMeetings(); // Executa o reset semanal
            await loadMeetings(); 
        };

        init();
    </script>
</body>
</html>

