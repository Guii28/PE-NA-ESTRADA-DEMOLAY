<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda Semanal</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant:wght@400;600&family=Montserrat:wght@700&display=swap" rel="stylesheet">
</head>
<body>

    <header>
        <h1>üóìÔ∏è Reuni√µes da Semana</h1>
        <button id="openNewMeetingModal" class="btn-primary">Criar Nova Reuni√£o</button>
    </header>

    <main id="meeting-list">
        </main>

    <div id="newMeetingModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Nova Reuni√£o</h2>
            <form id="newMeetingForm">
                <label for="meetingTitle">T√≠tulo:</label>
                <input type="text" id="meetingTitle" required maxlength="100">

                <label for="meetingDate">Data:</label>
                <input type="date" id="meetingDate" required>

                <label for="meetingTime">Hora:</label>
                <input type="time" id="meetingTime" required>

                <button type="submit" class="btn-primary">Salvar Reuni√£o</button>
            </form>
        </div>
    </div>

    <div id="addParticipantModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 id="participantMeetingTitle">Adicionar Participante</h2>
            <form id="addParticipantForm">
                <input type="hidden" id="participantMeetingId">

                <label for="participantName">Nome:</label>
                <input type="text" id="participantName" required maxlength="50">

                <label for="participantRole">Cargo (Ex: MCE):</label>
                <input type="text" id="participantRole" required maxlength="10">

                <button type="submit" class="btn-primary">Adicionar</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, query, where, deleteDoc, orderBy } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js';

        // SEU firebaseConfig
        const firebaseConfig = {
            apiKey: "AIzaSyBn_Wqa33wPRetrfm0-n_MVZGahi2dannY",
            authDomain: "e-na-estrada-dm.firebaseapp.com",
            projectId: "e-na-estrada-dm",
            storageBucket: "e-na-estrada-dm.firebasestorage.app",
            messagingSenderId: "597150480236",
            appId: "1:597150480236:web:4eb6d334d4d0672d8ba549",
            measurementId: "G-LX0MBXGY5W"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const REUNIOES_COLLECTION = "reunioes";

        // --- Fun√ß√µes Auxiliares de Data ---

        // Retorna o dia da semana (ex: pr√≥xima sexta) como objeto Date.
        const getNextDayOfWeek = (dayIndex) => { // 0=Dom, 1=Seg... 6=S√°b
            const today = new Date();
            const resultDate = new Date(today);
            const currentDay = today.getDay();
            let daysUntil = dayIndex - currentDay;

            if (daysUntil < 0) {
                daysUntil += 7; 
            }

            resultDate.setDate(today.getDate() + daysUntil);
            resultDate.setHours(0, 0, 0, 0); 
            return resultDate;
        };

        const formatDate = (dateISO, includeDayOfWeek = true) => {
            const date = new Date(dateISO + 'T00:00:00'); 
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const dayOfWeek = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'][date.getDay()];
            return includeDayOfWeek ? `${dayOfWeek} ‚Äî ${day}/${month}` : `${day}/${month}`;
        };

        // --- Rotina de Reset Semanal (Corrigida) ---

        const resetOldMeetings = async () => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // 5 = Sexta-feira (In√≠cio da semana de interesse)
            const targetDayIndex = 5; 

            // Calcula quantos dias se passaram desde a √∫ltima Sexta-feira.
            let daysSinceTarget = (today.getDay() - targetDayIndex + 7) % 7;

            const cutoffDate = new Date(today);
            cutoffDate.setDate(today.getDate() - daysSinceTarget);
            cutoffDate.setHours(0, 0, 0, 0); 

            const cutoffDateISO = cutoffDate.toISOString().split('T')[0];

            console.log(`[RESET] Verificando reuni√µes anteriores a (Corte na √∫ltima Sexta): ${cutoffDateISO}`);

            const q = query(
                collection(db, REUNIOES_COLLECTION),
                where("dataISO", "<", cutoffDateISO)
            );

            try {
                const snapshot = await getDocs(q);
                const docsToDelete = [];

                if (snapshot.empty) {
                    console.log("[RESET] Nenhuma reuni√£o antiga para deletar.");
                    return;
                }

                snapshot.forEach(doc => {
                    docsToDelete.push(doc.ref);
                });

                if (docsToDelete.length > 0) {
                    console.log(`[RESET] Deletando ${docsToDelete.length} reuni√µes antigas...`);
                    const deletePromises = docsToDelete.map(ref => deleteDoc(ref));
                    await Promise.all(deletePromises);
                    console.log("[RESET] Dele√ß√£o de reuni√µes antigas conclu√≠da.");
                }
            } catch (e) {
                console.error("[RESET] Erro durante a rotina de reset: ", e);
            }
        };

        // --- Renderiza√ß√£o e Carregamento de Dados ---

        const daysOfInterest = [
            { dayIndex: 5, name: 'Sexta' },
            { dayIndex: 6, name: 'S√°bado' },
            { dayIndex: 0, name: 'Domingo' }
        ];
        const dayMap = {};

        const setupDayStructure = () => {
            const meetingList = document.getElementById('meeting-list');
            meetingList.innerHTML = ''; 

            daysOfInterest.forEach(dayInfo => {
                const dayDate = getNextDayOfWeek(dayInfo.dayIndex);
                const dayDateISO = dayDate.toISOString().split('T')[0];
                dayMap[dayDateISO] = dayInfo; 

                const dayBlock = document.createElement('section');
                dayBlock.className = 'day-block';
                dayBlock.innerHTML = `
                    <h2>${dayInfo.name} ‚Äî ${formatDate(dayDateISO, false)}</h2>
                    <div id="meetings-for-${dayDateISO}" class="meetings-container">
                        <p class="no-meetings">Nenhuma reuni√£o agendada para este dia.</p>
                    </div>
                `;
                meetingList.appendChild(dayBlock);
            });
        };

        const renderMeetings = (meetings) => {
            document.querySelectorAll('.meetings-container').forEach(container => {
                container.innerHTML = '<p class="no-meetings">Nenhuma reuni√£o agendada para este dia.</p>';
            });

            meetings.forEach(meeting => {
                const containerId = `meetings-for-${meeting.dataISO}`;
                const container = document.getElementById(containerId);

                if (container) {
                    const noMeetingsMsg = container.querySelector('.no-meetings');
                    if (noMeetingsMsg) noMeetingsMsg.remove();

                    const meetingDiv = document.createElement('div');
                    meetingDiv.className = 'meeting-card';
                    meetingDiv.dataset.id = meeting.id;
                    meetingDiv.innerHTML = `
                        <div class="meeting-header">
                            <span class="meeting-time-badge">${meeting.hora}</span>
                            <h3 class="meeting-title">${meeting.titulo}</h3>
                        </div>
                        <ul class="participant-list" id="participants-for-${meeting.id}">
                            ${meeting.participantes.map(p => `<li>${p.nome} <span class="participant-role">(${p.cargo})</span></li>`).join('')}
                        </ul>
                        <button class="add-participant-btn" data-id="${meeting.id}" data-title="${meeting.titulo}">+ Participante</button>
                    `;

                    // Ordena por hora
                    let inserted = false;
                    const existingMeetings = Array.from(container.children).filter(el => el.classList.contains('meeting-card'));
                    for (const existing of existingMeetings) {
                        const existingTime = existing.querySelector('.meeting-time-badge').textContent;
                        if (meeting.hora < existingTime) {
                            container.insertBefore(meetingDiv, existing);
                            inserted = true;
                            break;
                        }
                    }
                    if (!inserted) {
                        container.appendChild(meetingDiv);
                    }
                }
            });

            // Re-adiciona listener para o bot√£o de participante
            document.querySelectorAll('.add-participant-btn').forEach(btn => {
                btn.onclick = () => openAddParticipantModal(btn.dataset.id, btn.dataset.title);
            });
        };

        const loadMeetings = async () => {
            const allMeetings = [];
            
            // Requer um √≠ndice composto no Firestore (dataISO, hora)
            const q = query(
                collection(db, REUNIOES_COLLECTION),
                where("dataISO", "in", Object.keys(dayMap)), // Filtra s√≥ os dias exibidos
                orderBy("dataISO"),
                orderBy("hora")
            );

            try {
                const snapshot = await getDocs(q);
                for (const docSnapshot of snapshot.docs) {
                    const meetingData = docSnapshot.data();
                    const meetingId = docSnapshot.id;

                    const participantsSnapshot = await getDocs(collection(db, REUNIOES_COLLECTION, meetingId, "participantes"));
                    const participantes = participantsSnapshot.docs.map(p => p.data());

                    allMeetings.push({
                        id: meetingId,
                        ...meetingData,
                        participantes: participantes || []
                    });
                }
                renderMeetings(allMeetings);
            } catch (e) {
                console.error("Erro ao carregar reuni√µes: ", e);
                // O FirebaseError sobre index deve ser resolvido criando o √≠ndice manualmente.
                alert("Erro ao carregar reuni√µes. Verifique o console. Se for erro de 'index', crie o √≠ndice no Firebase.");
            }
        };

        // --- Modals e Formul√°rios ---
        const newMeetingModal = document.getElementById('newMeetingModal');
        const openNewMeetingModalBtn = document.getElementById('openNewMeetingModal');
        const closeBtns = document.querySelectorAll('.close-btn');
        const newMeetingForm = document.getElementById('newMeetingForm');
        const addParticipantModal = document.getElementById('addParticipantModal');
        const addParticipantForm = document.getElementById('addParticipantForm');

        openNewMeetingModalBtn.onclick = () => newMeetingModal.style.display = 'block';
        closeBtns.forEach(btn => {
            btn.onclick = () => {
                newMeetingModal.style.display = 'none';
                addParticipantModal.style.display = 'none';
            };
        });
        window.onclick = (event) => {
            if (event.target == newMeetingModal) newMeetingModal.style.display = 'none';
            if (event.target == addParticipantModal) addParticipantModal.style.display = 'none';
        };

        const openAddParticipantModal = (meetingId, meetingTitle) => {
            document.getElementById('participantMeetingId').value = meetingId;
            document.getElementById('participantMeetingTitle').textContent = `Adicionar Participante: ${meetingTitle}`;
            document.getElementById('participantName').value = '';
            document.getElementById('participantRole').value = '';
            addParticipantModal.style.display = 'block';
        };

        // Submiss√£o de Nova Reuni√£o (FINAL)
        newMeetingForm.onsubmit = async (e) => {
            e.preventDefault();
            const titulo = document.getElementById('meetingTitle').value;
            const dataISO = document.getElementById('meetingDate').value;
            const hora = document.getElementById('meetingTime').value;

            // Valida√ß√£o simples: n√£o permite datas passadas
            if (dataISO < new Date().toISOString().split('T')[0]) {
                 alert("Por favor, selecione uma data no presente ou futuro.");
                 return;
            }

            try {
                const docRef = await addDoc(collection(db, REUNIOES_COLLECTION), {
                    titulo,
                    dataISO, 
                    hora,   
                    createdAt: new Date().toISOString()
                });
                console.log("Documento escrito com ID: ", docRef.id);
                newMeetingModal.style.display = 'none';
                newMeetingForm.reset();
                alert(`Reuni√£o "${titulo}" salva com sucesso!`);
                loadMeetings(); 
            } catch (e) {
                console.error("Erro ao adicionar documento: ", e);
                alert(`Erro ao salvar a reuni√£o. Verifique o console (F12) para detalhes. Erro: ${e.message}`);
            }
        };

        // Submiss√£o de Novo Participante
        addParticipantForm.onsubmit = async (e) => {
            e.preventDefault();
            const meetingId = document.getElementById('participantMeetingId').value;
            const nome = document.getElementById('participantName').value;
            const cargo = document.getElementById('participantRole').value;

            try {
                await addDoc(collection(db, REUNIOES_COLLECTION, meetingId, "participantes"), {
                    nome,
                    cargo,
                    joinedAt: new Date().toISOString()
                });
                addParticipantModal.style.display = 'none';
                addParticipantForm.reset();
                alert(`Participante ${nome} adicionado com sucesso!`);
                loadMeetings(); 
            } catch (e) {
                console.error("Erro ao adicionar participante: ", e);
                alert("Erro ao adicionar participante. Verifique o console.");
            }
        };

        // --- Inicializa√ß√£o ---

        const init = async () => {
            setupDayStructure(); 
            await resetOldMeetings(); 
            await loadMeetings(); 
        };

        init();
    </script>
</body>
</html>
